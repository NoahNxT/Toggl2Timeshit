name: ðŸ”– Release TUI
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g. 1.0.0)"
        required: true

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      release_tag: ${{ steps.set_tag.outputs.release_tag }}
      version: ${{ steps.set_tag.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version
        id: set_tag
        shell: bash
        run: |
          set -euo pipefail
          input="${{ inputs.version }}"
          version="${input#v}"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "release_tag=v${version}" >> "$GITHUB_OUTPUT"
          VERSION="${version}" python3 - <<'PY'
          import os, re
          version = os.environ["VERSION"]
          def replace_version(path):
              with open(path, "r", encoding="utf-8") as f:
                  data = f.read()
              data = re.sub(r'(?m)^version = ".*"$', f'version = "{version}"', data, count=1)
              with open(path, "w", encoding="utf-8") as f:
                  f.write(data)
          replace_version("Cargo.toml")
          # Update Chocolatey nuspec version
          with open("packaging/chocolatey/timeshit.nuspec", "r", encoding="utf-8") as f:
              nuspec = f.read()
          nuspec = re.sub(r"<version>[^<]*</version>", f"<version>{version}</version>", nuspec, count=1)
          with open("packaging/chocolatey/timeshit.nuspec", "w", encoding="utf-8") as f:
              f.write(nuspec)
          # Update Cargo.lock package version entry
          with open("Cargo.lock", "r", encoding="utf-8") as f:
              lines = f.readlines()
          out = []
          in_pkg = False
          for line in lines:
              if line.startswith("[[package]]"):
                  in_pkg = False
              if line.strip() == 'name = "timeshit"':
                  in_pkg = True
              if in_pkg and line.strip().startswith("version = "):
                  line = f'version = "{version}"\n'
                  in_pkg = False
              out.append(line)
          with open("Cargo.lock", "w", encoding="utf-8") as f:
              f.writelines(out)
          PY

      - name: Update changelog
        shell: bash
        env:
          VERSION: ${{ steps.set_tag.outputs.version }}
        run: |
          set -euo pipefail
          VERSION="${VERSION}" python3 - <<'PY'
          import datetime
          import os
          import re
          import subprocess
          from pathlib import Path

          version = os.environ["VERSION"]
          today = datetime.date.today().isoformat()
          changelog = Path("CHANGELOG.md")

          if not changelog.exists():
              changelog.write_text(
                  "\n".join(
                      [
                          "# Changelog",
                          "",
                          "All notable changes to this project will be documented in this file.",
                          "This file is auto-updated by the release workflow.",
                          "",
                          "## Unreleased",
                          "",
                          "- Work in progress.",
                          "",
                      ]
                  ),
                  encoding="utf-8",
              )

          text = changelog.read_text(encoding="utf-8")
          lines = text.splitlines()

          all_tags = (
              subprocess.check_output(
                  ["git", "tag", "--list", "v*", "--sort=-v:refname"], text=True
              )
              .strip()
              .splitlines()
          )
          current_tag = f"v{version}"
          previous_tag = next((tag for tag in all_tags if tag != current_tag), None)
          range_spec = "HEAD" if previous_tag is None else f"{previous_tag}..HEAD"

          commits = (
              subprocess.check_output(
                  ["git", "log", "--no-merges", "--pretty=format:%s", range_spec], text=True
              )
              .strip()
              .splitlines()
          )
          messages = []
          for subject in commits:
              subject = subject.strip()
              if not subject:
                  continue
              if "bump version to v" in subject.lower():
                  continue
              messages.append(subject)
          if not messages:
              messages = ["Internal maintenance updates."]
          notes = [f"- {subject}" for subject in messages]

          version_header_pattern = re.compile(
              rf"^## v{re.escape(version)} - \d{{4}}-\d{{2}}-\d{{2}}$"
          )
          cleaned = []
          index = 0
          while index < len(lines):
              if version_header_pattern.match(lines[index].strip()):
                  index += 1
                  while index < len(lines) and not lines[index].startswith("## "):
                      index += 1
                  continue
              cleaned.append(lines[index])
              index += 1
          lines = cleaned

          if not any(line.strip() == "## Unreleased" for line in lines):
              if lines and lines[-1].strip():
                  lines.append("")
              lines.extend(["## Unreleased", "", "- Work in progress.", ""])

          insert_at = len(lines)
          for i, line in enumerate(lines):
              if line.strip() == "## Unreleased":
                  j = i + 1
                  while j < len(lines) and not lines[j].startswith("## "):
                      j += 1
                  insert_at = j
                  break

          section = [f"## v{version} - {today}", "", *notes, ""]
          lines = lines[:insert_at] + section + lines[insert_at:]

          changelog.write_text("\n".join(lines).rstrip() + "\n", encoding="utf-8")
          PY

      - name: Verify changelog entry
        shell: bash
        run: |
          set -euo pipefail
          if ! grep -Eq "^## v${{ steps.set_tag.outputs.version }} - [0-9]{4}-[0-9]{2}-[0-9]{2}$" CHANGELOG.md; then
            echo "CHANGELOG.md is missing an entry for v${{ steps.set_tag.outputs.version }}."
            exit 1
          fi

      - name: Commit and tag
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add Cargo.toml Cargo.lock packaging/chocolatey/timeshit.nuspec
          if ! git diff --cached --quiet; then
            git commit -m "ðŸ”– bump version to v${{ steps.set_tag.outputs.version }}"
          fi
          if git rev-parse "v${{ steps.set_tag.outputs.version }}" >/dev/null 2>&1; then
            echo "Tag v${{ steps.set_tag.outputs.version }} already exists."
            exit 1
          fi
          git tag "v${{ steps.set_tag.outputs.version }}"
          git push origin main --tags

  build:
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04, macos-14, windows-2022]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.release_tag }}
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Build release
        run: cargo build --release
      - name: Install zip (Windows)
        if: runner.os == 'Windows'
        run: choco install zip -y
      - name: Package binary
        shell: bash
        run: |
          mkdir -p dist
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cp target/release/timeshit.exe dist/
            powershell -Command "Compress-Archive -Path dist\\timeshit.exe -DestinationPath dist\\timeshit-windows.zip"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            cp target/release/timeshit dist/timeshit-${RUNNER_OS}
            tar -czf dist/timeshit-${RUNNER_OS}.tar.gz -C dist timeshit-${RUNNER_OS}
            rm -rf pkgroot
            mkdir -p pkgroot/usr/local/bin
            cp target/release/timeshit pkgroot/usr/local/bin/timeshit
            pkgbuild --identifier com.nxtsolutions.timeshit \
              --version "${{ inputs.version }}" \
              --root pkgroot \
              dist/timeshit-macos.pkg
          else
            cp target/release/timeshit dist/timeshit-${RUNNER_OS}
            tar -czf dist/timeshit-${RUNNER_OS}.tar.gz -C dist timeshit-${RUNNER_OS}
          fi
      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: timeshit-${{ runner.os }}
          path: dist/*

  release:
    runs-on: ubuntu-22.04
    needs: [prepare, build]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.release_tag }}
          name: ${{ needs.prepare.outputs.release_tag }}
          generate_release_notes: true
          files: dist/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
