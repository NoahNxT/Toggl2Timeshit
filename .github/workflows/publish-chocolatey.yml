name: üç´ Publish Chocolatey

on:
  release:
    types: [published]
  workflow_run:
    workflows: ["üîñ Release TUI"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  chocolatey:
    if: ${{ github.event_name == 'release' || github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: windows-2022
    steps:
      - name: Guard missing Chocolatey API key
        shell: pwsh
        run: |
          if (-not "${{ secrets.CHOCOLATEY_API_KEY }}") {
            Write-Host "CHOCOLATEY_API_KEY not set; skipping."
            exit 0
          }

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve release tag
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "release") {
            $tag = "${{ github.event.release.tag_name }}"
          } elseif ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $tag = (Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest").tag_name
          } else {
            $tag = (Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest").tag_name
          }
          "RELEASE_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Append
          $version = $tag.TrimStart("v")
          "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Checkout release tag
        shell: pwsh
        run: |
          git fetch --tags
          git checkout $env:RELEASE_TAG

      - name: Download Windows release asset
        shell: pwsh
        run: |
          $url = "https://github.com/${{ github.repository }}/releases/download/$env:RELEASE_TAG/timeshit-windows.zip"
          Invoke-WebRequest -Uri $url -OutFile timeshit-windows.zip
          $hash = (Get-FileHash timeshit-windows.zip -Algorithm SHA256).Hash.ToLower()
          "CHECKSUM=$hash" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Prepare Chocolatey package
        shell: pwsh
        run: |
          $install = Get-Content packaging/chocolatey/tools/chocolateyinstall.ps1 -Raw
          $install = $install.Replace('@VERSION@', $env:VERSION).Replace('@CHECKSUM@', $env:CHECKSUM)
          $install | Set-Content packaging/chocolatey/tools/chocolateyinstall.ps1

      - name: Pack
        shell: pwsh
        run: |
          choco pack packaging/chocolatey/timeshit.nuspec --version $env:VERSION

      - name: Push
        shell: pwsh
        run: |
          choco push "timeshit.$env:VERSION.nupkg" --api-key ${{ secrets.CHOCOLATEY_API_KEY }} --source https://push.chocolatey.org/
