name: ðŸªŸ Publish Winget

on:
  release:
    types: [published]
  workflow_run:
    workflows: ["ðŸ”– Release TUI"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  winget:
    if: ${{ github.event_name == 'release' || github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: windows-2022
    steps:
      - name: Guard missing Winget config
        shell: pwsh
        run: |
          if (-not "${{ secrets.WINGET_TOKEN }}" -or -not "${{ vars.WINGET_PACKAGE_ID }}") {
            Write-Host "WINGET_TOKEN or WINGET_PACKAGE_ID not set; skipping."
            exit 0
          }

      - name: Resolve release tag
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "release") {
            $tag = "${{ github.event.release.tag_name }}"
          } elseif ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $tag = (Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest").tag_name
          } else {
            $tag = (Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest").tag_name
          }
          "RELEASE_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Download wingetcreate
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

      - name: Submit update
        shell: pwsh
        env:
          PACKAGE_ID: ${{ vars.WINGET_PACKAGE_ID }}
        run: |
          $tag = $env:RELEASE_TAG
          $version = $tag.TrimStart("v")
          $url = "https://github.com/${{ github.repository }}/releases/download/$tag/timeshit-windows.zip"

          $args = @(
            "update",
            "--submit",
            "--token", "${{ secrets.WINGET_TOKEN }}",
            "--urls", $url,
            "--version", $version,
            $env:PACKAGE_ID
          )

          & .\wingetcreate.exe @args
