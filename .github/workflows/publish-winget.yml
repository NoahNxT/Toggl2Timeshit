name: ðŸªŸ Publish Winget

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  winget:
    if: ${{ secrets.WINGET_TOKEN != '' && vars.WINGET_PACKAGE_ID != '' }}
    runs-on: windows-2022
    steps:
      - name: Download wingetcreate
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

      - name: Submit update
        shell: pwsh
        env:
          PACKAGE_ID: ${{ vars.WINGET_PACKAGE_ID }}
          PACKAGE_NAME: ${{ vars.WINGET_PACKAGE_NAME }}
        run: |
          $tag = "${{ github.event.release.tag_name }}"
          $version = $tag.TrimStart("v")
          $url = "https://github.com/${{ github.repository }}/releases/download/$tag/timeshit.exe"

          $args = @(
            "update",
            $env:PACKAGE_ID,
            "-u", $url,
            "-v", $version,
            "-t", "${{ secrets.WINGET_TOKEN }}",
            "--submit"
          )
          if ($env:PACKAGE_NAME) {
            $args += @("--package-name", $env:PACKAGE_NAME)
          }

          & .\wingetcreate.exe @args
