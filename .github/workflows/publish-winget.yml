name: ðŸªŸ Publish Winget

on:
  release:
    types: [published]
  workflow_run:
    workflows: ["ðŸ”– Release TUI"]
    types: [completed]

permissions:
  contents: read

jobs:
  winget:
    if: ${{ secrets.WINGET_TOKEN != '' && vars.WINGET_PACKAGE_ID != '' && (github.event_name == 'release' || github.event.workflow_run.conclusion == 'success') }}
    runs-on: windows-2022
    steps:
      - name: Resolve release tag
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "release") {
            $tag = "${{ github.event.release.tag_name }}"
          } else {
            $tag = (Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest").tag_name
          }
          "RELEASE_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Download wingetcreate
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

      - name: Submit update
        shell: pwsh
        env:
          PACKAGE_ID: ${{ vars.WINGET_PACKAGE_ID }}
          PACKAGE_NAME: ${{ vars.WINGET_PACKAGE_NAME }}
        run: |
          $tag = $env:RELEASE_TAG
          $version = $tag.TrimStart("v")
          $url = "https://github.com/${{ github.repository }}/releases/download/$tag/timeshit.exe"

          $args = @(
            "update",
            $env:PACKAGE_ID,
            "-u", $url,
            "-v", $version,
            "-t", "${{ secrets.WINGET_TOKEN }}",
            "--submit"
          )
          if ($env:PACKAGE_NAME) {
            $args += @("--package-name", $env:PACKAGE_NAME)
          }

          & .\wingetcreate.exe @args
