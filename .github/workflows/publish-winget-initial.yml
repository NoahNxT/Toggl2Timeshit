name: ðŸªŸ Publish Winget (Initial)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to submit (e.g. v1.3.6). Leave empty to use latest."
        required: false

permissions:
  contents: read

jobs:
  winget-initial:
    runs-on: windows-2022
    steps:
      - name: Guard missing Winget config
        shell: pwsh
        run: |
          if (-not "${{ secrets.WINGET_TOKEN }}" -or -not "${{ vars.WINGET_PACKAGE_ID }}") {
            Write-Host "WINGET_TOKEN or WINGET_PACKAGE_ID not set; skipping."
            exit 0
          }

      - name: Resolve release tag
        shell: pwsh
        run: |
          if ("${{ github.event.inputs.tag }}" -and "${{ github.event.inputs.tag }}" -ne "") {
            $tag = "${{ github.event.inputs.tag }}"
          } else {
            $tag = (Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest").tag_name
          }
          if (-not $tag.StartsWith("v")) {
            $tag = "v$tag"
          }
          "RELEASE_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Checkout winget-pkgs
        uses: actions/checkout@v4
        with:
          repository: microsoft/winget-pkgs
          token: ${{ secrets.WINGET_TOKEN }}

      - name: Download release asset
        shell: pwsh
        run: |
          $tag = $env:RELEASE_TAG
          $url = "https://github.com/${{ github.repository }}/releases/download/$tag/timeshit-windows.zip"
          Invoke-WebRequest -Uri $url -OutFile timeshit-windows.zip
          $sha = (Get-FileHash timeshit-windows.zip -Algorithm SHA256).Hash.ToLower()
          "INSTALLER_SHA=$sha" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Generate Winget manifest
        shell: pwsh
        env:
          PACKAGE_ID: ${{ vars.WINGET_PACKAGE_ID }}
          PACKAGE_NAME: ${{ vars.WINGET_PACKAGE_NAME }}
        run: |
          $tag = $env:RELEASE_TAG
          $version = $tag.TrimStart("v")
          $packageId = $env:PACKAGE_ID
          if (-not $packageId -or $packageId -eq "") {
            throw "WINGET_PACKAGE_ID is required."
          }
          $packageName = $env:PACKAGE_NAME
          if (-not $packageName -or $packageName -eq "") {
            $packageName = "Timeshit"
          }
          $publisher = $packageId.Split(".")[0]
          $package = ($packageId.Split(".") | Select-Object -Skip 1) -join "."
          $letter = $publisher.Substring(0,1).ToLower()
          $manifestDir = "manifests/$letter/$publisher/$package/$version"
          New-Item -ItemType Directory -Path $manifestDir -Force | Out-Null

          $url = "https://github.com/${{ github.repository }}/releases/download/$tag/timeshit-windows.zip"
          $sha = $env:INSTALLER_SHA

          $versionManifest = @(
            "PackageIdentifier: $packageId"
            "PackageVersion: $version"
            "DefaultLocale: en-US"
            "ManifestType: version"
            "ManifestVersion: 1.6.0"
          ) -join "`n"
          $versionManifest | Set-Content -Path "$manifestDir/$packageId.yaml" -Encoding UTF8

          $installerManifest = @(
            "PackageIdentifier: $packageId"
            "PackageVersion: $version"
            "InstallerType: zip"
            "Installers:"
            "  - Architecture: x64"
            "    InstallerUrl: $url"
            "    InstallerSha256: $sha"
            "    NestedInstallerType: portable"
            "    NestedInstallerFiles:"
            "      - RelativeFilePath: timeshit.exe"
            "        PortableCommandAlias: timeshit"
            "ManifestType: installer"
            "ManifestVersion: 1.6.0"
          ) -join "`n"
          $installerManifest | Set-Content -Path "$manifestDir/$packageId.installer.yaml" -Encoding UTF8

          $localeManifest = @(
            "PackageIdentifier: $packageId"
            "PackageVersion: $version"
            "PackageLocale: en-US"
            "Publisher: $publisher"
            "PackageName: $packageName"
            "License: MIT"
            "LicenseUrl: https://github.com/${{ github.repository }}/blob/main/LICENSE"
            "ShortDescription: Toggl Track to timesheet TUI"
            "PackageUrl: https://github.com/${{ github.repository }}"
            "PublisherUrl: https://github.com/${{ github.repository_owner }}"
            "Tags:"
            "  - toggl"
            "  - timesheet"
            "  - tui"
            "ManifestType: defaultLocale"
            "ManifestVersion: 1.6.0"
          ) -join "`n"
          $localeManifest | Set-Content -Path "$manifestDir/$packageId.locale.en-US.yaml" -Encoding UTF8

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.WINGET_TOKEN }}
          commit-message: "Add ${{ vars.WINGET_PACKAGE_ID }} ${{ env.RELEASE_TAG }}"
          title: "Add ${{ vars.WINGET_PACKAGE_ID }} ${{ env.RELEASE_TAG }}"
          body: |
            - Automated Winget initial submission for `${{ vars.WINGET_PACKAGE_ID }}`.
            - Release: `${{ env.RELEASE_TAG }}`
          branch: "winget-${{ env.RELEASE_TAG }}"
          push-to-fork: "${{ github.repository_owner }}/winget-pkgs"
