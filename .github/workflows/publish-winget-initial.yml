name: ðŸªŸ Publish Winget (Initial)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to submit (e.g. v1.3.6). Leave empty to use latest."
        required: false

permissions:
  contents: read

jobs:
  winget-initial:
    runs-on: windows-2022
    steps:
      - name: Guard missing Winget config
        shell: pwsh
        run: |
          if (-not "${{ secrets.WINGET_TOKEN }}" -or -not "${{ vars.WINGET_PACKAGE_ID }}") {
            Write-Host "WINGET_TOKEN or WINGET_PACKAGE_ID not set; skipping."
            exit 0
          }

      - name: Resolve release tag
        shell: pwsh
        run: |
          if ("${{ github.event.inputs.tag }}" -and "${{ github.event.inputs.tag }}" -ne "") {
            $tag = "${{ github.event.inputs.tag }}"
          } else {
            $tag = (Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest").tag_name
          }
          "RELEASE_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Download wingetcreate
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

      - name: Submit initial manifest
        shell: pwsh
        run: |
          $tag = $env:RELEASE_TAG
          $url = "https://github.com/${{ github.repository }}/releases/download/$tag/timeshit-windows.zip"

          $args = @(
            "new",
            "--out", "winget-manifest",
            "--token", "${{ secrets.WINGET_TOKEN }}",
            $url
          )

          & .\wingetcreate.exe @args
