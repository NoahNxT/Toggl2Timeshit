name: ðŸª£ Publish Scoop

on:
  release:
    types: [published]
  workflow_run:
    workflows: ["ðŸ”– Release TUI"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to publish (e.g. v1.3.6). Leave empty to use latest."
        required: false

permissions:
  contents: read

jobs:
  scoop:
    if: ${{ github.event_name == 'release' || github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-22.04
    steps:
      - name: Guard missing packages repo token
        run: |
          if [[ -z "${{ secrets.PACKAGES_REPO_TOKEN }}" ]]; then
            echo "PACKAGES_REPO_TOKEN not set; skipping."
            exit 0
          fi

      - name: Resolve release tag
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "RELEASE_TAG=${{ github.event.release.tag_name }}" >> "$GITHUB_ENV"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.tag }}" ]]; then
            echo "RELEASE_TAG=${{ github.event.inputs.tag }}" >> "$GITHUB_ENV"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            tag=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | python3 -c "import sys, json; print(json.load(sys.stdin)['tag_name'])")
            echo "RELEASE_TAG=$tag" >> "$GITHUB_ENV"
          else
            tag=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | python3 -c "import sys, json; print(json.load(sys.stdin)['tag_name'])")
            echo "RELEASE_TAG=$tag" >> "$GITHUB_ENV"
          fi

      - name: Checkout packages repo
        shell: bash
        env:
          PACKAGES_TOKEN: ${{ secrets.PACKAGES_REPO_TOKEN }}
        run: |
          set -euo pipefail
          default_branch=$(git ls-remote --symref "https://x-access-token:${PACKAGES_TOKEN}@github.com/NoahNxT/homebrew-nxt-solutions-packages.git" HEAD | \
            awk '/^ref:/ {print $2}' | sed 's@refs/heads/@@')
          if [[ -z "${default_branch}" ]]; then
            for candidate in main master; do
              if git ls-remote --heads "https://x-access-token:${PACKAGES_TOKEN}@github.com/NoahNxT/homebrew-nxt-solutions-packages.git" "${candidate}" | grep -q "${candidate}$"; then
                default_branch="${candidate}"
                break
              fi
            done
          fi
          if [[ -z "${default_branch}" ]]; then
            rm -rf nxt-solutions-packages
            mkdir nxt-solutions-packages
            cd nxt-solutions-packages
            git init -b main
            git remote add origin "https://x-access-token:${PACKAGES_TOKEN}@github.com/NoahNxT/homebrew-nxt-solutions-packages.git"
          else
            git clone "https://x-access-token:${PACKAGES_TOKEN}@github.com/NoahNxT/homebrew-nxt-solutions-packages.git" \
              --branch "${default_branch}" --depth 1 homebrew-nxt-solutions-packages
            cd homebrew-nxt-solutions-packages
          fi

      - name: Download release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "$RELEASE_TAG" -R "${{ github.repository }}" -p "timeshit-*.zip" -D /tmp/releases

      - name: Generate Scoop manifest
        working-directory: homebrew-nxt-solutions-packages
        run: |
          tag="${RELEASE_TAG}"
          version="${tag#v}"
          echo "VERSION=${version}" >> "$GITHUB_ENV"
          shopt -s nocaseglob nullglob
          win_candidates=(/tmp/releases/timeshit*windows*.zip)
          win_zip="${win_candidates[0]:-}"
          if [[ -z "$win_zip" ]]; then
            echo "Missing release assets for Scoop."
            ls -la /tmp/releases || true
            exit 1
          fi
          win_sha=$(shasum -a 256 "$win_zip" | awk '{print $1}')
          mkdir -p bucket
          printf '%s\n' \
            "{" \
            "  \"version\": \"${version}\"," \
            "  \"description\": \"Toggl Track to timesheet TUI\"," \
            "  \"homepage\": \"https://github.com/${{ github.repository }}\"," \
            "  \"license\": \"MIT\"," \
            "  \"architecture\": {" \
            "    \"64bit\": {" \
            "      \"url\": \"https://github.com/${{ github.repository }}/releases/download/${tag}/timeshit-windows.zip\"," \
            "      \"hash\": \"${win_sha}\"" \
            "    }" \
            "  }," \
            "  \"bin\": \"timeshit.exe\"" \
            "}" \
            > bucket/timeshit.json

      - name: Commit and push
        working-directory: homebrew-nxt-solutions-packages
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add bucket/timeshit.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "timeshit ${VERSION}"
          git push -u origin main
